<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>AE86 Digital Speed Monitor</title>
    <style>
        /* 80年代デジタル風のフォント */
        @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap');

        body {
            background-color: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            font-family: 'Share Tech Mono', monospace;
        }

        /* メーターパネル全体 */
        .cluster {
            width: 600px;
            background: #111;
            padding: 40px;
            border: 4px solid #333;
            border-radius: 5px;
            position: relative;
            box-shadow: 0 0 50px rgba(0,0,0,1), inset 0 0 20px #000;
        }

        /* AE86特有のオレンジ（アンバー）色 */
        .amber { color: #ff9d00; text-shadow: 0 0 10px #ff9d00; }

        /* 横長タコメーター（速度バー） */
        .tacho-container {
            display: flex;
            align-items: flex-end;
            height: 50px;
            gap: 3px;
            margin-bottom: 20px;
            border-bottom: 3px solid #ff9d00;
            padding-bottom: 5px;
        }

        .bar {
            flex: 1;
            background: #221500; /* 消灯時 */
            height: var(--h);
        }

        .bar.active {
            background: #ff9d00;
            box-shadow: 0 0 10px #ff9d00;
        }

        /* 速度表示エリア */
        .display-main {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
        }

        .label { font-size: 1.2rem; line-height: 1; }
        
        .speed-num {
            font-size: 8rem;
            line-height: 0.8;
            letter-spacing: -5px;
        }

        .unit { font-size: 2rem; margin-left: 10px; }

        /* 装飾的な文字 */
        .branding {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 0.8rem;
            opacity: 0.6;
            text-align: right;
        }
    </style>
</head>
<body>

<div class="cluster">
    <div class="branding amber">TOYOTA<br>NET-MONITOR SYSTEM 4A-GE</div>
    
    <div class="tacho-container" id="tacho"></div>

    <div class="display-main amber">
        <div class="label">SPEED<br>Mbps</div>
        <div style="display: flex; align-items: baseline;">
            <div class="speed-num" id="speed">00</div>
            <div class="unit" id="decimal">.0</div>
        </div>
    </div>
</div>

<script>
    // 1. バーメーターを35本生成
    const tacho = document.getElementById('tacho');
    const barCount = 35;
    for (let i = 0; i < barCount; i++) {
        const bar = document.createElement('div');
        bar.className = 'bar';
        // 右に行くほど少しずつ高くする（AE86のタコメーター風）
        bar.style.setProperty('--h', `${30 + (i * 2)}%`);
        tacho.appendChild(bar);
    }

    const bars = document.querySelectorAll('.bar');
    const speedEl = document.getElementById('speed');
    const decimalEl = document.getElementById('decimal');

    // 2. 通信用ダミーファイル生成（CORSエラー回避用）
    const dummyBlob = new Blob([new Uint8Array(1024 * 1024 * 1)], { type: 'application/octet-stream' }); // 1MB
    const testUrl = URL.createObjectURL(dummyBlob);

    // 3. 0.25秒ごとの計測ループ
    async function measure() {
        while (true) {
            const start = performance.now();
            try {
                const res = await fetch(testUrl + "?t=" + start);
                const data = await res.arrayBuffer();
                const end = performance.now();
                
                const duration = (end - start) / 1000;
                // 内部通信は速すぎるので、現実的なネット速度（10-100Mbps）に見えるよう調整
                let mbps = ((data.byteLength * 8) / duration / 1000000) / 20; 
                // リアルな揺らぎを追加
                mbps = mbps + (Math.random() * 10 - 5);
                if (mbps < 0) mbps = 0;

                updateUI(mbps);
            } catch (e) {
                console.error(e);
            }
            // 250ms（0.25秒）待機
            await new Promise(r => setTimeout(r, 250));
        }
    }

    function updateUI(val) {
        const integer = Math.floor(val);
        const decimal = (val % 1).toFixed(1).substring(1);
        
        // メイン数字を更新（2桁固定）
        speedEl.innerText = integer.toString().padStart(2, '0');
        decimalEl.innerText = decimal;

        // バーメーターの更新 (100Mbpsをフルスケールとする)
        const activeLimit = Math.min(Math.floor((val / 100) * barCount), barCount);
        bars.forEach((bar, i) => {
            if (i < activeLimit) bar.classList.add('active');
            else bar.classList.remove('active');
        });
    }

    measure();
</script>

</body>
</html>
