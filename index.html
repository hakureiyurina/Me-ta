<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>High-Speed Network Monitor</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --neon-green: #39ff14; --dark-bg: #050505; }
        body { background: var(--dark-bg); color: white; font-family: 'Courier New', monospace; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        
        .monitor-grid { display: grid; grid-template-columns: 1fr 1.5fr; gap: 20px; width: 95%; max-width: 1000px; }

        /* スピードメーター風エリア */
        .gauge-container { 
            background: #111; border: 2px solid #333; border-radius: 15px; 
            padding: 20px; position: relative; text-align: center;
            box-shadow: inset 0 0 20px #000;
        }
        .needle { 
            position: absolute; bottom: 50%; left: 50%; width: 3px; height: 90px; 
            background: var(--neon-green); transform-origin: bottom center;
            transform: translateX(-50%) rotate(-90deg); transition: transform 0.15s linear;
            box-shadow: 0 0 8px var(--neon-green);
        }
        .speed-display { font-size: 4rem; font-weight: bold; color: var(--neon-green); margin: 20px 0 0; }
        
        /* グラフエリア */
        .chart-container { background: #111; border: 1px solid #333; border-radius: 15px; padding: 10px; height: 250px; }

        .info { margin-top: 15px; color: #666; font-size: 0.8rem; }
        .blink { animation: blinker 0.25s step-start infinite; color: var(--neon-green); font-weight: bold; }
        @keyframes blinker { 50% { opacity: 0; } }
    </style>
</head>
<body>

    <div style="margin-bottom: 20px;">
        <span class="blink">●</span> HIGH-FREQUENCY MONITORING (4Hz)
    </div>

    <div class="monitor-grid">
        <div class="gauge-container">
            <div style="color: #444; font-size: 0.7rem;">INSTANTANEOUS SPEED</div>
            <div class="speed-display" id="speed-text">0.0</div>
            <div style="color: #666; margin-bottom: 50px;">Mbps</div>
            <div class="needle" id="needle"></div>
        </div>

        <div class="chart-container">
            <canvas id="liveChart"></canvas>
        </div>
    </div>

    <div class="info" id="data-info">Sampling...</div>

<script>
    const speedText = document.getElementById('speed-text');
    const needle = document.getElementById('needle');
    const dataInfo = document.getElementById('data-info');
    const ctx = document.getElementById('liveChart').getContext('2d');

    // グラフ初期化 (直近50サンプル = 約12.5秒分表示)
    let chartData = Array(50).fill(0);
    const chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: Array(50).fill(''),
            datasets: [{
                data: chartData,
                borderColor: '#39ff14',
                borderWidth: 2,
                fill: true,
                backgroundColor: 'rgba(57, 255, 20, 0.05)',
                tension: 0.3,
                pointRadius: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            animation: false,
            scales: {
                y: { min: 0, max: 150, grid: { color: '#222' }, ticks: { color: '#555' } },
                x: { display: false }
            },
            plugins: { legend: { display: false } }
        }
    });

    // 0.25秒おきに実行するメインループ
    async function highFreqMonitor() {
        // 計測対象：軽量なライブラリファイル (約30KB) を使用
        // 0.25秒間隔ならこのサイズが適切です
        const targetUrl = "https://code.jquery.com/jquery-3.7.1.get.min.js"; 
        
        while (true) {
            const loopStart = performance.now();
            
            try {
                const startTime = performance.now();
                const response = await fetch(targetUrl + "?t=" + startTime, { cache: "no-store" });
                const data = await response.arrayBuffer();
                const endTime = performance.now();

                const duration = (endTime - startTime) / 1000; // 秒
                const mbps = ((data.byteLength * 8) / duration / 1000000);
                
                updateUI(mbps);
                dataInfo.innerText = `Last chunk: ${data.byteLength} bytes / Time: ${(duration*1000).toFixed(0)}ms`;
            } catch (e) {
                speedText.style.color = "red";
            }

            // ループの実行時間を差し引いて、正確に250msごとに実行されるよう調整
            const elapsed = performance.now() - loopStart;
            const delay = Math.max(0, 250 - elapsed);
            await new Promise(r => setTimeout(r, delay));
        }
    }

    function updateUI(mbps) {
        const displayValue = mbps.toFixed(1);
        speedText.innerText = displayValue;

        // 針の回転 (0-150Mbps想定)
        const rotation = Math.min((mbps / 150) * 180 - 90, 90);
        needle.style.transform = `translateX(-50%) rotate(${rotation}deg)`;

        // グラフ更新
        chartData.push(mbps);
        chartData.shift();
        chart.update('none');
    }

    highFreqMonitor();
</script>
</body>
</html>
