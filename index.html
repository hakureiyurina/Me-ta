<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Scale TRD Cluster</title>
    <style>
        body { background: #050505; display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100vh; margin: 0; color: #eee; font-family: sans-serif; }
        canvas { background: #000; border: 3px solid #444; border-radius: 20px; max-width: 95vw; box-shadow: 0 0 40px rgba(0,0,0,1); }
        .ui-panel { margin-top: 25px; display: flex; gap: 30px; align-items: center; }
        #boostBtn { 
            width: 85px; height: 85px; border-radius: 50%; border: 5px solid #500;
            background: #200; color: #f33; font-weight: bold; font-size: 22px;
            cursor: pointer; transition: 0.1s; box-shadow: 0 0 15px #500;
        }
        #boostBtn.active { background: #f00; color: #fff; border-color: #ffaaaa; box-shadow: 0 0 40px #f00; transform: scale(1.1) translateY(-5px); }
        #toggleBtn { padding: 12px 25px; background: #333; color: #aaa; border: 1px solid #555; border-radius: 5px; cursor: pointer; font-weight: bold; }
        #toggleBtn.active { color: #0f0; border-color: #0f0; }
        .label { font-family: monospace; color: #666; font-size: 12px; margin-top: 10px; }
    </style>
</head>
<body>

<canvas id="cluster" width="850" height="400"></canvas>

<div class="ui-panel">
    <button id="toggleBtn">IGNITION</button>
    <button id="boostBtn">Br</button>
</div>
<div class="label">BOOST ON: 0.0 - 60.0 (DETAILED) / OFF: 0 - 200 (WIDE)</div>

<script>
const canvas = document.getElementById('cluster');
const ctx = canvas.getContext('2d');
const btn = document.getElementById('toggleBtn');
const boostBtn = document.getElementById('boostBtn');

let isRunning = false;
let isBoost = false;
let currentVal = 0, targetVal = 0;
let currentRpm = 0, targetRpm = 0;

// データ取得と更新 (0.5秒おき)
function update() {
    if (!isRunning) return;
    const conn = navigator.connection || { downlink: 45 };
    let speed = conn.downlink || 45;

    // 生の通信速度をターゲットにする
    targetVal = speed * (0.8 + Math.random() * 0.4);
    targetRpm = 1000 + (targetVal * 40);
}
setInterval(update, 500);

btn.onclick = () => {
    isRunning = !isRunning;
    btn.classList.toggle('active');
    btn.innerText = isRunning ? "ENGINE ON" : "IGNITION";
    if (!isRunning) { targetVal = 0; targetRpm = 0; isBoost = false; boostBtn.classList.remove('active'); }
};

boostBtn.onclick = () => { if(isRunning) { isBoost = !isBoost; boostBtn.classList.toggle('active'); } };

function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    // 針の動き（ブースト時はズームするので少し速めに追従）
    let easing = isBoost ? 0.15 : 0.08;
    currentVal += (targetVal - currentVal) * easing;
    currentRpm += (targetRpm - currentRpm) * easing;

    // 左：可変スケールメーター
    // 通常時 MAX:200 / ブースト時 MAX:60
    let maxRange = isBoost ? 60 : 200;
    let step = isBoost ? 2.5 : 10;
    
    drawGauge(ctx, 240, 200, 160, 0, maxRange, currentVal, "Mbps", step, isBoost);
    
    // 右：タコメーター（固定スケール 0-8000）
    drawGauge(ctx, 610, 200, 160, 0, 8000, currentRpm, "x1000r/min", 1000, isBoost);

    requestAnimationFrame(draw);
}

function drawGauge(ctx, x, y, radius, min, max, value, label, step, boostMode) {
    const startAngle = 0.75 * Math.PI;
    const endAngle = 2.25 * Math.PI;

    // メーターのベース
    ctx.strokeStyle = boostMode ? "rgba(255,0,0,0.3)" : "#333";
    ctx.lineWidth = 4;
    ctx.beginPath();
    ctx.arc(x, y, radius, startAngle, endAngle);
    ctx.stroke();

    // 目盛りと数字の描画
    for (let i = min; i <= max; i += step) {
        let angle = startAngle + ((i - min) / (max - min)) * (endAngle - startAngle);
        let isMain = (i % (step * 2) === 0) || boostMode; // ブースト時は全目盛りを強調

        ctx.strokeStyle = isMain ? "white" : "#444";
        ctx.lineWidth = isMain ? 2 : 1;
        ctx.beginPath();
        let innerR = isMain ? 15 : 7;
        ctx.moveTo(x + Math.cos(angle) * (radius - innerR), y + Math.sin(angle) * (radius - innerR));
        ctx.lineTo(x + Math.cos(angle) * radius, y + Math.sin(angle) * radius);
        ctx.stroke();

        // 数字の描画 (メイン目盛りのみ)
        if (isMain) {
            ctx.fillStyle = "white";
            ctx.font = boostMode ? "bold 12px Arial" : "italic bold 15px Arial";
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            let tx = x + Math.cos(angle) * (radius - 35);
            let ty = y + Math.sin(angle) * (radius - 35);
            
            let displayVal = (max === 8000) ? i/1000 : i;
            ctx.fillText(displayVal, tx, ty);
        }
    }

    // 針の描画
    let needleVal = Math.min(value, max); // メーターを突き抜けないようにガード
    let needleAngle = startAngle + ((needleVal - min) / (max - min)) * (endAngle - startAngle);
    
    ctx.shadowBlur = boostMode ? 20 : 0;
    ctx.shadowColor = "red";
    ctx.strokeStyle = boostMode ? "#fff" : "#ff4500";
    ctx.lineWidth = 5;
    ctx.lineCap = "round";
    ctx.beginPath();
    ctx.moveTo(x, y);
    ctx.lineTo(x + Math.cos(needleAngle) * (radius - 20), y + Math.sin(needleAngle) * (radius - 20));
    ctx.stroke();
    ctx.shadowBlur = 0;

    // センターキャップ
    ctx.beginPath();
    ctx.arc(x, y, 12, 0, Math.PI * 2);
    ctx.fillStyle = "#111";
    ctx.fill();
    ctx.strokeStyle = "#444";
    ctx.stroke();

    ctx.fillStyle = boostMode ? "#f00" : "#888";
    ctx.font = "bold 14px Arial";
    ctx.fillText(label, x, y + 60);
    if(boostMode && max !== 8000) {
        ctx.font = "10px monospace";
        ctx.fillText("HIGH-RES SCAN", x, y - 40);
    }
}

draw();
</script>
</body>
</html>
