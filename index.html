<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRD Full Custom Cluster</title>
    <style>
        body { background: #000; display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100vh; margin: 0; color: #eee; font-family: sans-serif; overflow: hidden; }
        canvas { background: #000; border: 2px solid #222; border-radius: 10px; max-width: 98vw; }
        .panel { margin-top: 15px; display: flex; gap: 20px; }
        button { padding: 10px 20px; border-radius: 5px; border: none; font-weight: bold; cursor: pointer; }
        #boostBtn { background: #200; color: #f00; border: 2px solid #500; }
        #boostBtn.active { background: #f00; color: #fff; box-shadow: 0 0 20px #f00; }
    </style>
</head>
<body>

<canvas id="cluster" width="1000" height="450"></canvas>

<div class="panel">
    <button id="toggleBtn" style="background: #333; color: white;">IGNITION</button>
    <button id="boostBtn">Br</button>
</div>

<script>
const canvas = document.getElementById('cluster');
const ctx = canvas.getContext('2d');
const boostBtn = document.getElementById('boostBtn');
const toggleBtn = document.getElementById('toggleBtn');

let isRunning = false;
let isBoost = false;
let speed = 0, targetSpeed = 0;
let rpm = 0, targetRpm = 0;
let rtt = 0; // 反応速度(Ping)

// 0.5秒おきのデータ更新
setInterval(() => {
    if (!isRunning) return;
    const conn = navigator.connection || { downlink: 40, rtt: 50 };
    let s = conn.downlink || 40;
    rtt = conn.rtt || 50;

    targetSpeed = s * (0.9 + Math.random() * 0.2);
    targetRpm = 1000 + (targetSpeed * 35);
}, 500);

toggleBtn.onclick = () => { isRunning = !isRunning; toggleBtn.style.color = isRunning ? "#0f0" : "#fff"; };
boostBtn.onclick = () => { if(isRunning) { isBoost = !isBoost; boostBtn.classList.toggle('active'); }};

function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    let easing = isBoost ? 0.15 : 0.08;
    speed += (targetSpeed - speed) * easing;
    rpm += (targetRpm - rpm) * easing;

    // --- メインメーター (ラフの1, 2) ---
    const maxS = isBoost ? 60 : 200;
    const stepS = isBoost ? 2.5 : 10;
    drawGauge(ctx, 300, 220, 180, 0, maxS, speed, "Mbps", stepS, isBoost, "TRD");
    drawGauge(ctx, 700, 220, 180, 0, 8000, rpm, "RPM", 1000, isBoost, "TACHO");

    // --- 左側：時刻計 (ラフの「時刻」) ---
    drawSubGauge(ctx, 60, 300, 80, "CLOCK", getFormattedTime());

    // --- 右側下：RTT/通信品質 (ラフの3, 4) ---
    drawSubGauge(ctx, 800, 380, 100, "RTT/ms", Math.floor(rtt));

    // --- 警告灯 (ラフの「20以下でもえた」) ---
    // Wi-Fi速度が20以下、またはエンジンOFF時に点灯
    if (!isRunning || speed < 20) {
        drawWarningLight(ctx, 100, 150, "BRAKE", "#f00", (Math.sin(Date.now()/200) > 0)); 
    }

    requestAnimationFrame(draw);
}

function getFormattedTime() {
    const now = new Date();
    return now.getHours().toString().padStart(2, '0') + ":" + now.getMinutes().toString().padStart(2, '0');
}

function drawGauge(ctx, x, y, radius, min, max, value, label, step, boost, title) {
    const startAngle = 0.75 * Math.PI;
    const endAngle = 2.25 * Math.PI;

    // 目盛り
    for (let i = min; i <= max; i += step) {
        let angle = startAngle + ((i - min) / (max - min)) * (endAngle - startAngle);
        let isMain = (i % (step * 2) === 0) || boost;
        ctx.strokeStyle = isMain ? "#fff" : "#444";
        ctx.lineWidth = isMain ? 2 : 1;
        ctx.beginPath();
        ctx.moveTo(x + Math.cos(angle)*(radius-10), y + Math.sin(angle)*(radius-10));
        ctx.lineTo(x + Math.cos(angle)*radius, y + Math.sin(angle)*radius);
        ctx.stroke();

        if (isMain) {
            ctx.fillStyle = "#fff";
            ctx.font = "14px Arial";
            ctx.textAlign = "center";
            ctx.fillText((max === 8000 ? i/1000 : i), x + Math.cos(angle)*(radius-30), y + Math.sin(angle)*(radius-30));
        }
    }

    // 針
    let nAngle = startAngle + ((Math.min(value, max) - min) / (max - min)) * (endAngle - startAngle);
    ctx.strokeStyle = boost ? "#fff" : "#ff4500";
    ctx.lineWidth = 4;
    ctx.beginPath();
    ctx.moveTo(x, y);
    ctx.lineTo(x + Math.cos(nAngle)*(radius-15), y + Math.sin(nAngle)*(radius-15));
    ctx.stroke();

    ctx.fillStyle = "#888";
    ctx.font = "bold 16px Arial";
    ctx.fillText(title, x, y - 40);
}

function drawSubGauge(ctx, x, y, width, label, value) {
    ctx.fillStyle = "#222";
    ctx.fillRect(x, y, width, 40);
    ctx.strokeStyle = "#444";
    ctx.strokeRect(x, y, width, 40);
    ctx.fillStyle = "#fff";
    ctx.font = "bold 18px monospace";
    ctx.textAlign = "left";
    ctx.fillText(value, x + 10, y + 25);
    ctx.font = "10px Arial";
    ctx.fillStyle = "#666";
    ctx.fillText(label, x, y - 5);
}

function drawWarningLight(ctx, x, y, text, color, isOn) {
    ctx.globalAlpha = isOn ? 1.0 : 0.2;
    ctx.fillStyle = color;
    ctx.beginPath();
    ctx.arc(x, y, 15, 0, Math.PI*2);
    ctx.fill();
    ctx.font = "bold 10px Arial";
    ctx.textAlign = "center";
    ctx.fillText(text, x, y + 30);
    ctx.globalAlpha = 1.0;
}

draw();
</script>
</body>
</html>
