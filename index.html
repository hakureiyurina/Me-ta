<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wi-Fi Speed TRD Cluster</title>
    <style>
        body { background: #050505; display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100vh; margin: 0; color: #eee; font-family: sans-serif; overflow: hidden; }
        canvas { background: radial-gradient(circle, #1a1a1a 0%, #000 100%); border: 2px solid #333; border-radius: 15px; max-width: 90vw; max-height: 60vh; }
        .controls { margin-top: 20px; text-align: center; }
        button { padding: 15px 30px; font-size: 18px; font-weight: bold; background: #0066cc; color: white; border: none; border-radius: 8px; cursor: pointer; }
        button:active { transform: scale(0.98); background: #0055aa; }
        .status { margin-top: 15px; font-family: monospace; color: #00ff00; height: 20px; text-shadow: 0 0 5px #00ff00; }
    </style>
</head>
<body>

<canvas id="cluster" width="850" height="350"></canvas>

<div class="controls">
    <button id="testBtn">Wi-Fiをスキャンして加速</button>
    <div id="speedText" class="status">SYSTEM READY</div>
</div>

<script>
const canvas = document.getElementById('cluster');
const ctx = canvas.getContext('2d');
const btn = document.getElementById('testBtn');
const statusText = document.getElementById('speedText');

let currentMbps = 0;
let targetMbps = 0;
let currentRpm = 800;
let targetRpm = 800;

// メインの計測ロジック
function measureSpeed() {
    btn.disabled = true;
    statusText.innerText = "SCANNING NETWORK...";

    // 1. ブラウザが持っている通信情報を取得（もしあれば）
    let connection = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
    let baseSpeed = connection ? connection.downlink : 50; // デフォルト50Mbps

    // 2. 演出用の加速（一気に針を振る）
    targetMbps = baseSpeed * 1.5 + Math.random() * 20;
    targetRpm = 6500 + Math.random() * 1000;

    // 3. 2秒後に安定させる
    setTimeout(() => {
        targetMbps = baseSpeed + Math.random() * 10;
        targetRpm = 3000 + (targetMbps * 20);
        statusText.innerText = `LINK SPEED: ${targetMbps.toFixed(1)} Mbps`;
    }, 1500);

    // 4. 5秒後にアイドリングに戻す
    setTimeout(() => {
        targetMbps = 0;
        targetRpm = 800;
        btn.disabled = false;
        statusText.innerText = "READY";
    }, 5000);
}

btn.onclick = measureSpeed;

function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    // 針の物理挙動（ヌルヌル動かす）
    currentMbps += (targetMbps - currentMbps) * 0.05;
    currentRpm += (targetRpm - currentRpm) * 0.07;

    drawGauge(ctx, 220, 175, 150, 0, 240, currentMbps, "km/h (Mbps)", "TRD");
    drawGauge(ctx, 630, 175, 150, 0, 8000, currentRpm, "x1000r/min", "TACHO");

    requestAnimationFrame(draw);
}

function drawGauge(ctx, x, y, radius, min, max, value, unit, label) {
    const startAngle = 0.75 * Math.PI;
    const endAngle = 2.25 * Math.PI;

    // 背景の円弧
    ctx.strokeStyle = "#444";
    ctx.lineWidth = 3;
    ctx.beginPath();
    ctx.arc(x, y, radius, startAngle, endAngle);
    ctx.stroke();

    // 目盛りと数字
    for (let i = min; i <= max; i += (max / 8)) {
        let angle = startAngle + ((i - min) / (max - min)) * (endAngle - startAngle);
        ctx.strokeStyle = "white";
        ctx.beginPath();
        ctx.moveTo(x + Math.cos(angle) * (radius - 5), y + Math.sin(angle) * (radius - 5));
        ctx.lineTo(x + Math.cos(angle) * radius, y + Math.sin(angle) * radius);
        ctx.stroke();
        
        ctx.fillStyle = "white";
        ctx.font = "bold 14px Arial";
        ctx.textAlign = "center";
        let tx = x + Math.cos(angle) * (radius - 25);
        let ty = y + Math.sin(angle) * (radius - 25);
        ctx.fillText(Math.floor(max === 8000 ? i/1000 : i), tx, ty);
    }

    // 針 (AE86 TRD風オレンジ)
    let needleAngle = startAngle + ((value - min) / (max - min)) * (endAngle - startAngle);
    ctx.shadowBlur = 15;
    ctx.shadowColor = "rgba(255, 69, 0, 0.6)";
    ctx.strokeStyle = "#ff4500";
    ctx.lineWidth = 5;
    ctx.lineCap = "round";
    ctx.beginPath();
    ctx.moveTo(x, y);
    ctx.lineTo(x + Math.cos(needleAngle) * (radius - 20), y + Math.sin(needleAngle) * (radius - 20));
    ctx.stroke();
    ctx.shadowBlur = 0;

    // センターピン
    ctx.beginPath();
    ctx.arc(x, y, 10, 0, Math.PI * 2);
    ctx.fillStyle = "#111";
    ctx.fill();
    ctx.strokeStyle = "#444";
    ctx.stroke();

    ctx.fillStyle = "#888";
    ctx.font = "16px Arial";
    ctx.fillText(label, x, y - 40);
    ctx.font = "12px Arial";
    ctx.fillText(unit, x, y + 60);
}

draw();
</script>
</body>
</html>
