<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Real-time Network Monitor</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --neon-blue: #00d2ff; --neon-pink: #ff007f; }
        body { background: #0a0e14; color: white; font-family: 'Segoe UI', sans-serif; display: flex; flex-direction: column; align-items: center; margin: 0; padding: 20px; }
        
        h1 { font-size: 1.2rem; color: var(--neon-blue); text-shadow: 0 0 10px var(--neon-blue); margin-bottom: 20px; }

        .container { display: flex; flex-wrap: wrap; justify-content: center; gap: 30px; max-width: 1000px; }

        /* メーター部分 */
        .gauge-box { position: relative; width: 300px; height: 180px; background: #161b22; border-radius: 20px; border: 1px solid #30363d; display: flex; flex-direction: column; align-items: center; justify-content: center; overflow: hidden; }
        .needle { 
            position: absolute; bottom: 40px; left: 50%; width: 4px; height: 100px; 
            background: var(--neon-pink); border-radius: 4px; transform-origin: bottom center;
            transform: translateX(-50%) rotate(-90deg); transition: transform 0.5s cubic-bezier(0.1, 0.5, 0.1, 1); z-index: 5;
            box-shadow: 0 0 10px var(--neon-pink);
        }
        .speed-val { font-size: 3rem; font-weight: 900; z-index: 10; margin-top: 40px; color: #fff; }
        .unit { font-size: 1rem; color: #8b949e; }

        /* グラフ部分 */
        .graph-box { width: 450px; height: 180px; background: #161b22; border-radius: 20px; border: 1px solid #30363d; padding: 15px; box-sizing: border-box; }

        .status-bar { margin-top: 20px; padding: 10px 20px; background: #21262d; border-radius: 30px; font-size: 0.9rem; border: 1px solid var(--neon-blue); box-shadow: 0 0 10px rgba(0,210,255,0.2); }
        .dot { display: inline-block; width: 10px; height: 10px; background: #00ff00; border-radius: 50%; margin-right: 8px; animation: blink 1s infinite; }
        @keyframes blink { 0% { opacity: 0.2; } 50% { opacity: 1; } 100% { opacity: 0.2; } }
    </style>
</head>
<body>

    <h1>NETWORK LIVE MONITOR</h1>

    <div class="container">
        <div class="gauge-box">
            <div class="needle" id="needle"></div>
            <div class="speed-val" id="speed-text">0.0</div>
            <div class="unit">Mbps</div>
        </div>

        <div class="graph-box">
            <canvas id="speedChart"></canvas>
        </div>
    </div>

    <div class="status-bar">
        <span class="dot"></span> LIVE MEASURING...
    </div>

<script>
    const speedText = document.getElementById('speed-text');
    const needle = document.getElementById('needle');
    const ctx = document.getElementById('speedChart').getContext('2d');

    // グラフの設定
    let speedData = Array(20).fill(0);
    let labels = Array(20).fill('');
    const chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Speed (Mbps)',
                data: speedData,
                borderColor: '#00d2ff',
                backgroundColor: 'rgba(0, 210, 255, 0.1)',
                fill: true,
                tension: 0.4,
                pointRadius: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: { y: { beginAtZero: true, grid: { color: '#30363d' } }, x: { display: false } },
            plugins: { legend: { display: false } }
        }
    });

    // 計測メインループ
    async function monitor() {
        while (true) {
            try {
                const startTime = performance.now();
                // 軽量なファイルをリクエストして速度を測る
                const response = await fetch("https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js?cache=" + Math.random(), { cache: "no-store" });
                const blob = await response.blob();
                const endTime = performance.now();

                const duration = (endTime - startTime) / 1000;
                const mbps = ( (blob.size * 8) / duration / 1000000 ).toFixed(1);

                updateUI(parseFloat(mbps));
            } catch (e) {
                console.error("Connection lost");
            }
            // 1.5秒ごとに再計測（サーバー負荷を考慮しつつリアルタイム性を維持）
            await new Promise(r => setTimeout(r, 1500));
        }
    }

    function updateUI(speed) {
        // メーター更新
        speedText.innerText = speed;
        const maxDisplaySpeed = 100;
        const rotation = Math.min((speed / maxDisplaySpeed) * 180 - 90, 90);
        needle.style.transform = `translateX(-50%) rotate(${rotation}deg)`;

        // グラフ更新
        speedData.push(speed);
        speedData.shift();
        chart.update('none'); // アニメーションなしで高速更新
    }

    // 実行開始
    monitor();
</script>
</body>
</html>
