<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRD V6 300km/h Custom</title>
    <style>
        body { background: #000; display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100vh; margin: 0; overflow: hidden; }
        #container { position: relative; border: 4px solid #1a1a1a; border-radius: 20px; box-shadow: 0 0 100px #000; }
        canvas { background: #020202; display: block; border-radius: 16px; }
        .buttons { margin-top: 25px; display: flex; gap: 30px; }
        button { background: #111; color: #555; border: 2px solid #333; padding: 12px 30px; border-radius: 6px; cursor: pointer; font-weight: bold; }
        #ignBtn.active { color: #f00; border-color: #f00; box-shadow: 0 0 15px rgba(255,0,0,0.3); }
        #brBtn { width: 75px; height: 75px; border-radius: 50%; font-size: 20px; border: 4px solid #300; }
        #brBtn.active { background: #f00; color: #fff; box-shadow: 0 0 30px #f00; }
    </style>
</head>
<body>

<div id="container">
    <canvas id="cluster" width="1050" height="480"></canvas>
</div>

<div class="buttons">
    <button id="ignBtn">ENGINE START</button>
    <button id="brBtn">Br</button>
</div>

<script>
const canvas = document.getElementById('cluster');
const ctx = canvas.getContext('2d');
const ignBtn = document.getElementById('ignBtn');
const brBtn = document.getElementById('brBtn');

let running = false, boost = false;
let downMbps = 0, upMbps = 0, rtt = 0;
let dispDown = 0, dispUp = 0;

// --- ネットワーク計測ロジック ---
async function measure() {
    if (!running) return;
    const testUrl = "https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js?n=" + Date.now();
    try {
        const start = Date.now();
        const res = await fetch(testUrl, { mode: 'cors' });
        const blob = await res.blob();
        const dur = (Date.now() - start) / 1000;
        downMbps = (blob.size * 8 / dur) / 1000000 * 50; // 300まで動きやすく調整
        rtt = Math.floor(dur * 1000);
        upMbps = downMbps * 0.6;
    } catch (e) {
        const n = navigator.connection || {};
        downMbps = (n.downlink || 20) * 10;
        upMbps = downMbps * 0.5;
    }
}
setInterval(measure, 2000);

// --- V6エンジンサウンド・シンセサイザー ---
let audioCtx, osc1, osc2, osc3, gainNode;

function initV6Sound() {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    gainNode = audioCtx.createGain();
    
    // V6の低音、中音、倍音を重ねる
    osc1 = audioCtx.createOscillator(); // 基音
    osc2 = audioCtx.createOscillator(); // 1.5倍（V型特有の揺らぎ用）
    osc3 = audioCtx.createOscillator(); // 倍音（金属的な響き）
    
    osc1.type = 'sawtooth';
    osc2.type = 'sawtooth';
    osc3.type = 'triangle';
    
    osc1.connect(gainNode);
    osc2.connect(gainNode);
    osc3.connect(gainNode);
    gainNode.connect(audioCtx.destination);
    
    osc1.start(); osc2.start(); osc3.start();
    gainNode.gain.setValueAtTime(0, audioCtx.currentTime);
}

function updateV6Sound(speed) {
    if(!audioCtx || !running) return;
    // 速度0-300を周波数に変換
    const baseFreq = 30 + (speed / 300) * 120;
    osc1.frequency.setTargetAtTime(baseFreq, audioCtx.currentTime, 0.1);
    osc2.frequency.setTargetAtTime(baseFreq * 1.501, audioCtx.currentTime, 0.1); // 微妙にずらして唸りを出す
    osc3.frequency.setTargetAtTime(baseFreq * 2.0, audioCtx.currentTime, 0.1);
    
    const vol = 0.1 + (speed / 300) * 0.6;
    gainNode.gain.setTargetAtTime(vol, audioCtx.currentTime, 0.1);
}

ignBtn.onclick = () => {
    if(!audioCtx) initV6Sound();
    running = !running;
    ignBtn.classList.toggle('active');
    if(!running) {
        gainNode.gain.setTargetAtTime(0, audioCtx.currentTime, 0.2);
    }
};

brBtn.onclick = () => { if(running) boost = !boost; brBtn.classList.toggle('active'); };

function draw() {
    ctx.fillStyle = "#000"; ctx.fillRect(0, 0, canvas.width, canvas.height);
    let ease = boost ? 0.15 : 0.05;
    dispDown += (downMbps - dispDown) * ease;
    dispUp += (upMbps - dispUp) * ease;

    updateV6Sound(dispDown);

    // 左右メーター (MAX 300)
    drawTRDGauge(ctx, 320, 240, 200, 0, 300, dispDown, 20, boost, "DOWNLOAD (V6)");
    drawTRDGauge(ctx, 730, 240, 200, 0, 300, dispUp, 20, boost, "UPLOAD (V6)");

    // デジタル枠
    drawBox(ctx, 60, 380, 140, "CLOCK", new Date().toLocaleTimeString('ja-JP',{hour:'2-digit',minute:'2-digit'}), "#aaa");
    drawBox(ctx, 750, 410, 120, "PING", rtt + "ms", "#f70");
    drawBox(ctx, 885, 410, 120, "V6-MODE", (running ? "ACTIVE" : "OFF"), "#0f0");

    if((running && dispDown < 20) || !running) {
        if(Math.sin(Date.now()/150) > 0) drawWarning(ctx, 110, 180, "BRAKE");
    }

    requestAnimationFrame(draw);
}

function drawTRDGauge(ctx, x, y, r, min, max, val, step, isB, title) {
    const start = 0.75 * Math.PI, end = 2.25 * Math.PI;
    for (let i = min; i <= max; i += step) {
        let ang = start + ((i - min) / (max - min)) * (end - start);
        let main = (i % (step * 2) === 0);
        ctx.strokeStyle = main ? "#eee" : "#222";
        ctx.lineWidth = main ? 3 : 1;
        ctx.beginPath();
        ctx.moveTo(x + Math.cos(ang)*(r-15), y + Math.sin(ang)*(r-15));
        ctx.lineTo(x + Math.cos(ang)*r, y + Math.sin(ang)*r);
        ctx.stroke();
        if (main) {
            ctx.fillStyle = running ? "#fff" : "#333";
            ctx.font = `italic bold 18px Arial`;
            ctx.textAlign = "center";
            ctx.fillText(i, x + Math.cos(ang)*(r-40), y + Math.sin(ang)*(r-40));
        }
    }
    let nAng = start + ((Math.min(val, max) - min) / (max - min)) * (end - start);
    ctx.shadowBlur = running ? 20 : 0; ctx.shadowColor = isB ? "#fff" : "#f00";
    ctx.strokeStyle = isB ? "#fff" : "#ff4500";
    ctx.lineWidth = 6; ctx.lineCap = "round";
    ctx.beginPath(); ctx.moveTo(x, y);
    ctx.lineTo(x + Math.cos(nAng)*(r-25), y + Math.sin(nAng)*(r-25));
    ctx.stroke(); ctx.shadowBlur = 0;
    ctx.fillStyle = "#666"; ctx.font = "bold 20px Arial"; ctx.textAlign = "center";
    ctx.fillText(title, x, y - 50);
}

function drawBox(ctx, x, y, w, label, val, col) {
    ctx.fillStyle = "#050505"; ctx.fillRect(x, y, w, 45);
    ctx.strokeStyle = "#222"; ctx.strokeRect(x, y, w, 45);
    ctx.fillStyle = running ? col : "#222";
    ctx.font = "bold 20px monospace"; ctx.textAlign = "center";
    ctx.fillText(val, x + w/2, y + 32);
    ctx.fillStyle = "#444"; ctx.font = "9px Arial"; ctx.fillText(label, x + w/2, y - 8);
}

function drawWarning(ctx, x, y, txt) {
    ctx.fillStyle = "#f00"; ctx.beginPath(); ctx.arc(x,y,18,0,Math.PI*2); ctx.fill();
    ctx.fillStyle = "#fff"; ctx.font = "bold 9px Arial"; ctx.textAlign = "center"; ctx.fillText(txt, x, y + 35);
}

draw();
</script>
</body>
</html>
