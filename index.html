<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Wi-Fi Speed TRD Cluster</title>
    <style>
        body { background: #050505; display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100vh; margin: 0; color: #eee; font-family: sans-serif; }
        canvas { background: radial-gradient(circle, #1a1a1a 0%, #000 100%); border: 4px solid #333; border-radius: 15px; }
        .controls { margin-top: 20px; text-align: center; }
        button { padding: 15px 30px; font-size: 18px; background: #0066cc; color: white; border: none; border-radius: 5px; cursor: pointer; }
        .status { margin-top: 10px; color: #888; }
    </style>
</head>
<body>

<canvas id="cluster" width="850" height="350"></canvas>

<div class="controls">
    <button id="testBtn">Wi-Fi速度を計測して加速</button>
    <div id="speedText" class="status">待機中...</div>
</div>

<script>
const canvas = document.getElementById('cluster');
const ctx = canvas.getContext('2d');
const btn = document.getElementById('testBtn');
const statusText = document.getElementById('speedText');

let currentMbps = 0;
let targetMbps = 0;
let rpm = 800;

// ダミーデータ（5MB）をダウンロードして速度を測る関数
async function measureSpeed() {
    btn.disabled = true;
    statusText.innerText = "通信中...";
    const startTime = new Date().getTime();
    
    try {
        // キャッシュを避けるためのランダムパラメータ付きURL
        const response = await fetch('https://upload.wikimedia.org/wikipedia/commons/3/3d/LARGE_elevated_view_of_the_Giza_Pyramid_Complex_of_Egypt._%28700MB%29.jpg?cb=' + startTime);
        const reader = response.body.getReader();
        let receivedLength = 0;

        while(true) {
            const {done, value} = await reader.read();
            if (done) break;
            receivedLength += value.length;
            
            // リアルタイム速度計算
            const duration = (new Date().getTime() - startTime) / 1000;
            const bitsLoaded = receivedLength * 8;
            const mbps = (bitsLoaded / duration) / 1000000;
            
            targetMbps = Math.min(mbps, 240); // メーター上限240
            rpm = 800 + (targetMbps * 25);   // 速度に合わせて回転数も上げる
            statusText.innerText = `現在の速度: ${mbps.toFixed(2)} Mbps`;
            
            if (duration > 5) break; // 5秒で計測終了
        }
    } catch (e) {
        statusText.innerText = "エラー: 接続を確認してください";
    }
    
    // 徐々に減速させる
    setTimeout(() => { targetMbps = 0; rpm = 800; btn.disabled = false; statusText.innerText = "計測完了"; }, 2000);
}

btn.onclick = measureSpeed;

function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    // 針の動きを滑らかにする（イージング）
    currentMbps += (targetMbps - currentMbps) * 0.1;

    drawGauge(ctx, 220, 175, 150, 0, 240, currentMbps, "Mbps (Speed)", "Wi-Fi");
    drawGauge(ctx, 630, 175, 150, 0, 8000, rpm, "x1000r/min", "ENGINE");

    requestAnimationFrame(draw);
}

function drawGauge(ctx, x, y, radius, min, max, value, unit, label) {
    const startAngle = 0.75 * Math.PI;
    const endAngle = 2.25 * Math.PI;
    
    // 目盛り描画
    ctx.strokeStyle = "#fff"; ctx.lineWidth = 2;
    for (let i = min; i <= max; i += (max / 10)) {
        let angle = startAngle + ((i - min) / (max - min)) * (endAngle - startAngle);
        ctx.beginPath();
        ctx.moveTo(x + Math.cos(angle) * (radius - 5), y + Math.sin(angle) * (radius - 5));
        ctx.lineTo(x + Math.cos(angle) * radius, y + Math.sin(angle) * radius);
        ctx.stroke();
    }

    // 針
    let needleAngle = startAngle + ((value - min) / (max - min)) * (endAngle - startAngle);
    ctx.strokeStyle = "#ff4500"; ctx.lineWidth = 4;
    ctx.beginPath(); ctx.moveTo(x, y);
    ctx.lineTo(x + Math.cos(needleAngle) * (radius - 20), y + Math.sin(needleAngle) * (radius - 20));
    ctx.stroke();

    ctx.fillStyle = "white"; ctx.textAlign = "center";
    ctx.fillText(label, x, y - 50);
    ctx.fillText(unit, x, y + 60);
}

draw();
</script>
</body>
</html>
